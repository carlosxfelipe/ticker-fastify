<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configura√ß√µes - Ticker</title>
  <link rel="stylesheet" href="../css/style.css">
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js" defer></script>
</head>
<body x-data="settingsApp()" x-init="init()">
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1>üéØ Ticker - Configura√ß√µes</h1>
      <nav class="nav">
        <a href="dashboard.html">Dashboard</a>
        <a href="assets.html">Ativos</a>
        <a href="settings.html">Configura√ß√µes</a>
        <button @click="logout()" class="btn btn-secondary btn-sm">Sair</button>
      </nav>
    </div>
  </div>
  
  <div class="container">
    <!-- User Info -->
    <div class="card">
      <h2 class="card-title">Informa√ß√µes da Conta</h2>
      
      <div x-show="loading" class="alert alert-info">
        Carregando informa√ß√µes...
      </div>
      
      <div x-show="!loading && userInfo">
        <div class="form-group">
          <label class="form-label">Email</label>
          <input 
            type="email" 
            class="form-input" 
            x-model="userInfo.email"
            disabled
            style="background: var(--bg); cursor: not-allowed;"
          >
        </div>
        
        <div class="form-group">
          <label class="form-label">Data de Cadastro</label>
          <input 
            type="text" 
            class="form-input" 
            :value="formatDate(userInfo.created_at)"
            disabled
            style="background: var(--bg); cursor: not-allowed;"
          >
        </div>
      </div>
    </div>
    
    <!-- Change Password -->
    <div class="card">
      <h2 class="card-title">Alterar Senha</h2>
      
      <div id="password-message"></div>
      
      <form @submit.prevent="changePassword()">
        <div class="form-group">
          <label class="form-label" for="old_password">Senha Atual</label>
          <input 
            type="password" 
            id="old_password" 
            class="form-input" 
            x-model="passwordForm.old_password"
            required
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          >
        </div>
        
        <div class="form-group">
          <label class="form-label" for="new_password">Nova Senha</label>
          <input 
            type="password" 
            id="new_password" 
            class="form-input" 
            x-model="passwordForm.new_password"
            required
            minlength="6"
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          >
          <small style="color: var(--text-light);">M√≠nimo 6 caracteres</small>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="confirm_password">Confirmar Nova Senha</label>
          <input 
            type="password" 
            id="confirm_password" 
            class="form-input" 
            x-model="passwordForm.confirm_password"
            required
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          >
        </div>
        
        <div x-show="passwordForm.new_password && passwordForm.confirm_password && passwordForm.new_password !== passwordForm.confirm_password" class="alert alert-error" style="margin-bottom: 1rem;">
          As senhas n√£o coincidem
        </div>
        
        <button 
          type="submit" 
          class="btn btn-primary"
          :disabled="loadingPassword || passwordForm.new_password !== passwordForm.confirm_password"
        >
          <span x-show="!loadingPassword">Alterar Senha</span>
          <span x-show="loadingPassword">Alterando...</span>
        </button>
      </form>
    </div>
    
    <!-- Danger Zone -->
    <div class="card" style="border: 2px solid var(--danger);">
      <h2 class="card-title" style="color: var(--danger);">Zona de Perigo</h2>
      
      <div id="delete-message"></div>
      
      <p style="margin-bottom: 1rem; color: var(--text-light);">
        Ao excluir sua conta, todos os seus dados ser√£o permanentemente removidos, incluindo todos os ativos cadastrados.
        Esta a√ß√£o n√£o pode ser desfeita.
      </p>
      
      <button 
        @click="confirmDeleteAccount()" 
        class="btn btn-danger"
        :disabled="loadingDelete"
      >
        <span x-show="!loadingDelete">Excluir Conta</span>
        <span x-show="loadingDelete">Excluindo...</span>
      </button>
    </div>
  </div>
  
  <script src="../js/auth.js"></script>
  <script>
    function settingsApp() {
      return {
        loading: true,
        loadingPassword: false,
        loadingDelete: false,
        userInfo: null,
        passwordForm: {
          old_password: '',
          new_password: '',
          confirm_password: ''
        },
        
        async init() {
          requireAuth();
          await this.loadUserInfo();
        },
        
        async loadUserInfo() {
          this.loading = true;
          
          try {
            const token = getToken();
            const response = await fetch('http://localhost:3000/settings/', {
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              }
            });
            
            if (!response.ok) {
              throw new Error('Erro ao carregar informa√ß√µes');
            }
            
            this.userInfo = await response.json();
          } catch (error) {
            console.error('Erro:', error);
          } finally {
            this.loading = false;
          }
        },
        
        async changePassword() {
          if (this.passwordForm.new_password !== this.passwordForm.confirm_password) {
            this.showPasswordMessage('As senhas n√£o coincidem', 'error');
            return;
          }
          
          this.loadingPassword = true;
          this.showPasswordMessage('', '');
          
          try {
            const token = getToken();
            const response = await fetch('http://localhost:3000/accounts/password_change/', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                old_password: this.passwordForm.old_password,
                new_password: this.passwordForm.new_password
              })
            });
            
            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.error || 'Erro ao alterar senha');
            }
            
            this.showPasswordMessage('Senha alterada com sucesso!', 'success');
            this.passwordForm = {
              old_password: '',
              new_password: '',
              confirm_password: ''
            };
          } catch (error) {
            console.error('Erro:', error);
            this.showPasswordMessage(error.message, 'error');
          } finally {
            this.loadingPassword = false;
          }
        },
        
        async confirmDeleteAccount() {
          const confirmed = confirm(
            'ATEN√á√ÉO: Voc√™ tem certeza que deseja excluir sua conta?\n\n' +
            'Esta a√ß√£o ir√°:\n' +
            '‚Ä¢ Excluir todos os seus ativos\n' +
            '‚Ä¢ Excluir todas as suas informa√ß√µes\n' +
            '‚Ä¢ Esta a√ß√£o N√ÉO PODE ser desfeita\n\n' +
            'Digite OK abaixo para confirmar:'
          );
          
          if (!confirmed) {
            return;
          }
          
          const doubleConfirm = prompt('Digite OK para confirmar a exclus√£o:');
          
          if (doubleConfirm !== 'OK') {
            alert('Exclus√£o cancelada');
            return;
          }
          
          await this.deleteAccount();
        },
        
        async deleteAccount() {
          this.loadingDelete = true;
          this.showDeleteMessage('', '');
          
          try {
            const token = getToken();
            const response = await fetch('http://localhost:3000/settings/delete/', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              }
            });
            
            if (!response.ok) {
              throw new Error('Erro ao excluir conta');
            }
            
            this.showDeleteMessage('Conta exclu√≠da com sucesso! Redirecionando...', 'success');
            
            clearToken();
            
            setTimeout(() => {
              window.location.href = 'login.html';
            }, 2000);
          } catch (error) {
            console.error('Erro:', error);
            this.showDeleteMessage(error.message, 'error');
          } finally {
            this.loadingDelete = false;
          }
        },
        
        showPasswordMessage(message, type) {
          const messageArea = document.getElementById('password-message');
          if (!message) {
            messageArea.innerHTML = '';
            return;
          }
          
          messageArea.innerHTML = `
            <div class="alert alert-${type}">
              ${message}
            </div>
          `;
          
          if (type === 'success') {
            setTimeout(() => {
              messageArea.innerHTML = '';
            }, 3000);
          }
        },
        
        showDeleteMessage(message, type) {
          const messageArea = document.getElementById('delete-message');
          if (!message) {
            messageArea.innerHTML = '';
            return;
          }
          
          messageArea.innerHTML = `
            <div class="alert alert-${type}">
              ${message}
            </div>
          `;
        },
        
        formatDate(dateString) {
          return new Date(dateString).toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        },
        
        logout() {
          logout();
        }
      }
    }
  </script>
</body>
</html>
